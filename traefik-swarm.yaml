# =============================================================================
# TRAEFIK WITH DOCKER SWARM - HIGH AVAILABILITY CONFIGURATION
# =============================================================================
#
# DESCRIPTION:
#   Traefik reverse proxy configured for Docker Swarm mode with
#   automatic service discovery and Let's Encrypt SSL.
#
# DEPLOYMENT:
#   docker stack deploy -c traefik-swarm.yaml traefik
#
# =============================================================================

services:
  traefik:
    image: traefik:latest
    ports:
      - target: 80
        published: 80
        mode: host
      - target: 443
        published: 443
        mode: host
    environment:
      - DOCKER_API_VERSION=1.44
    networks:
      - traefik-public
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-public-certificates:/certificates
    command:
      # Docker Swarm provider configuration
      - --providers.swarm=true
      - --providers.swarm.exposedbydefault=false
      - --providers.swarm.endpoint=unix:///var/run/docker.sock
      - --providers.swarm.network=traefik-public

      # Entrypoints configuration
      - --entrypoints.http.address=:80
      - --entrypoints.https.address=:443

      # Let's Encrypt configuration
      - --certificatesresolvers.le.acme.email=${ACME_EMAIL}
      - --certificatesresolvers.le.acme.storage=/certificates/acme.json
      - --certificatesresolvers.le.acme.tlschallenge=true

      # Logging and API configuration
      - --accesslog
      - --log.level=DEBUG
      - --api
    deploy:
      mode: global
      placement:
        constraints:
          - node.role == manager
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
      labels:
        - traefik.enable=true
        - traefik.swarm.network=traefik-public
        - traefik.http.services.traefik-dashboard.loadbalancer.server.port=8080

        # HTTP to HTTPS redirect middleware
        - traefik.http.middlewares.https-redirect.redirectscheme.scheme=https
        - traefik.http.middlewares.https-redirect.redirectscheme.permanent=true

        # Dashboard HTTP router
        - traefik.http.routers.traefik-dashboard-http.entrypoints=http
        - traefik.http.routers.traefik-dashboard-http.rule=Host(`traefik-sg.naseira.com`)
        - traefik.http.routers.traefik-dashboard-http.middlewares=https-redirect

        # Dashboard HTTPS router
        - traefik.http.routers.traefik-dashboard-https.entrypoints=https
        - traefik.http.routers.traefik-dashboard-https.rule=Host(`traefik-sg.naseira.com`)
        - traefik.http.routers.traefik-dashboard-https.tls=true
        - traefik.http.routers.traefik-dashboard-https.tls.certresolver=le
        - traefik.http.routers.traefik-dashboard-https.service=api@internal

        # Basic Auth for dashboard
        - traefik.http.middlewares.admin-auth.basicauth.users=admin:$2y$05$UHw.pfAQObWpSjqiqYGC0Ox.8ijkd6p2EgiDn2bRF1af8n9g29Uji
        - traefik.http.routers.traefik-dashboard-https.middlewares=admin-auth

volumes:
  traefik-public-certificates:

networks:
  traefik-public:
    external: true
